syntax = "proto3";

import "modal_proto/api.proto";

package modal.sandbox_router;

enum SandboxExecStderrConfig {
  // The output will be discarded.
  SANDBOX_EXEC_STDERR_CONFIG_DEVNULL = 0;
  // The output will be streamed to the client.
  SANDBOX_EXEC_STDERR_CONFIG_PIPE = 1;
  // A special value that can be used to indicate that the stderr stream should
  // be merged with the stdout stream.
  SANDBOX_EXEC_STDERR_CONFIG_STDOUT = 2;
}

enum SandboxExecStdioFileDescriptor {
  // Read from stdout.
  SANDBOX_EXEC_STDIO_FILE_DESCRIPTOR_STDOUT = 0;
  // Read from stderr.
  SANDBOX_EXEC_STDIO_FILE_DESCRIPTOR_STDERR = 1;
}

enum SandboxExecStdoutConfig {
  // The output will be discarded.
  SANDBOX_EXEC_STDOUT_CONFIG_DEVNULL = 0;
  // The output will be streamed to the client.
  SANDBOX_EXEC_STDOUT_CONFIG_PIPE = 1;
}

message SandboxExecStartRequest {
  // The task ID of the sandbox to execute the command in.
  string task_id = 1;
  // Execution ID. This ID will be used to identify the execution for other
  // requests and ensure exec commands are idempotent.
  //
  // TODO(saltzm): Could instead have a separate idempotency key from the exec_id
  // like present day, and have the server generate the exec_id and return it in
  // the ExecStartResponse.
  string exec_id = 2;
  // Command arguments to execute.
  repeated string command_args= 3;
  // Configures how the stdout of the command will be handled.
  SandboxExecStdoutConfig stdout_config = 4;
  // Configures how the stderr of the command will be handled.
  SandboxExecStderrConfig stderr_config = 5;
  // Timeout in seconds for the exec'd command to exit. If the command does not
  // exit within this duration, the command will be killed. This is NOT the
  // timeout for the ExecStartRequest RPC to complete.
  optional uint32 timeout_secs = 6;
  // Working directory for the command.
  optional string workdir = 7;
  // Secret IDs to mount into the sandbox.
  repeated string secret_ids = 8;
  // PTY info for the command.
  optional modal.client.PTYInfo pty_info = 9;
  // Enable debugging capabilities on the container runtime. Used only for
  // internal debugging.
  bool runtime_debug = 10;
}

message SandboxExecStartResponse { }

message SandboxExecStdinWriteRequest {
  // The task ID of the sandbox running the exec'd command.
  string task_id = 1;
  // The execution ID of the command to write to.
  string exec_id = 2;
  // The offset to start writing to. This is used to resume writing from the
  // last write position if the connection is closed and reopened.
  uint64 offset = 3;
  bytes data = 4;
  // If true, close the stdin stream after writing any provided data.
  // This signals EOF to the exec'd process.
  bool eof = 5;
}

message SandboxExecStdinWriteResponse { }


message SandboxExecStdioReadRequest {
  // The task ID of the sandbox running the exec'd command.
  string task_id = 1;
  // The execution ID of the command to read from.
  string exec_id = 2;
  // The offset to start reading from. This is used to resume reading from the
  // last read position if the connection is closed and reopened.
  uint64 offset = 3;
  // Which file descriptor to read from.
  SandboxExecStdioFileDescriptor file_descriptor = 4;
}

message SandboxExecStdioReadResponse {
  // The data read from the file descriptor.
  bytes data = 1;
}

message SandboxExecWaitRequest {
  // The task ID of the sandbox running the exec'd command.
  string task_id = 1;
  // The execution ID of the command to wait on. 
  string exec_id = 2;
}

message SandboxExecWaitResponse {
  oneof exit_status {
    // The exit code of the command.
    int32 code = 3;
    // The signal that terminated the command.
    int32 signal = 4;
  }
  // TODO(saltzm): Give a way for the user to distinguish between normal exit
  // and termination by Modal (due to sandbox timeout, exec exceeded deadline, etc.)
}

service SandboxRouter {
  // Execute a command in the sandbox.
  rpc SandboxExecStart(SandboxExecStartRequest) returns (SandboxExecStartResponse);
 // Write to the stdin stream of an exec'd command.
  rpc SandboxExecStdinWrite(SandboxExecStdinWriteRequest) returns (SandboxExecStdinWriteResponse);
  // Get a stream of output from the stdout or stderr stream of an exec'd command.
  rpc SandboxExecStdioRead(SandboxExecStdioReadRequest) returns (stream SandboxExecStdioReadResponse);
  // Wait for an exec'd command to exit and return the exit code.
  rpc SandboxExecWait(SandboxExecWaitRequest) returns (SandboxExecWaitResponse);
}
